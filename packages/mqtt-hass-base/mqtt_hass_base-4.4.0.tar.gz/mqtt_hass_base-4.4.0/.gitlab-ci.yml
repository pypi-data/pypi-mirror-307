variables:
  TWINE_USERNAME: __token__

stages:
- test
- pypi

test:
  stage: test
  tags:
  - $RUNNER_TAG
  image: registry.gitlab.com/hydroqc/hydroqc-base-container/3.12:latest
  services:
    - name: eclipse-mosquitto:2.0.20
      alias: mqtt
      entrypoint:
        - "/bin/sh"
      command:
        - -c
        - cp mosquitto-no-auth.conf /mosquitto/config/mosquitto.conf && cat /mosquitto/config/mosquitto.conf && /docker-entrypoint.sh mosquitto -c /mosquitto/config/mosquitto.conf
  variables:
    MQTT_HOST: mqtt
  script:
    #- apt-get update && apt-get install -y git python3-pip graphviz jq python3.11 python3.11-venv python3-pip python3.11-dev
    - apt-get update && apt-get install -y git graphviz jq
    - cat renovate.json |jq > /dev/null 2&>1 || ( echo "renovate.json not valid" && exit 1 )
    - pip install tox
    - tox
    - cat mypy-txt-report/index.txt
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      junit: "*junit.xml"
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - mypy-txt-report/
      - mypy-html-report/
      - classes.png
      - classes.mmd
      - classes.html
      - packages.png
      - packages.mmd
      - packages.html
      - htmlcov
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_COMMIT_TAG'
      when: never
    - when: on_success

package:
  image: registry.gitlab.com/hydroqc/hydroqc-base-container/3.12:latest
  stage: pypi
  tags:
  - $RUNNER_TAG
  script:
    #- apt-get update && apt-get install -y python3.11 python3-pip python3.11-venv
    - pip install --upgrade pip
    - pip install --upgrade build setuptools_scm
    - python3 -m build -o dist/
    - pip install twine
    - python3 -m twine check --strict dist/*
    - TWINE_PASSWORD=${CI_JOB_TOKEN} TWINE_USERNAME=gitlab-ci-token python3 -m twine upload --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
  only:
  - master

promote2pypi:
  image: registry.gitlab.com/hydroqc/hydroqc-base-container/3.12:latest
  stage: pypi
  tags:
  - $RUNNER_TAG
  script:
    # TODO: try to pull the good package from gitlab pypi repo
    #       then change the version (promote)
    #       then push it to pypi
    #- rm -rf dist
    #- mkdir -p dist
    #- cd dist
    #- VERSION=$(curl https://gitlab.com/api/v4/prokects/${CI_PROJECT_ID}/packages | jq '.[] | select(.pipelines[0].sha == "${CI_COMMIT_SHA}") | .version')
    #- echo "We need to download version ${VERSION}"
    #- |
    #  pip download Hydro-Quebec-API-Wrapper==${CURRENT_VERSION}rc${} --extra-index-url https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/pypi/simple --no-deps --no-binary :all:
    #- |
    #  pip download Hydro-Quebec-API-Wrapper --extra-index-url https://gitlab.com/api/v4/projects/${CI_PROJECT_ID}/packages/pypi/simple --no-deps
    # TODO: open archives edit versions and rebuild archive
    #- cd ..
    # Build package that could be promoted
    #- apt-get update && apt-get install -y python3.11 python3-pip python3.11-venv
    - pip install --upgrade pip
    - pip install --upgrade build setuptools_scm
    - python3 -m build -o dist
    - pip install twine
    - python3 -m twine check --strict dist/*
    - twine upload --verbose --non-interactive --repository pypi dist/*
  only:
  - tags
