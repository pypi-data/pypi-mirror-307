"use strict";(self.webpackChunkhome_assistant_frontend=self.webpackChunkhome_assistant_frontend||[]).push([[16204],{77226:function(e,t,i){i.d(t,{A:function(){return n}});i(71499),i(28552),i(36016),i(55228),i(43037);var a=function(e){var t=parseFloat(e);if(isNaN(t))throw new Error("".concat(e," is not a number"));return t};function n(e){if(!e)return null;try{if(e.endsWith("%"))return{w:100,h:a(e.substr(0,e.length-1))};var t=e.replace(":","x").split("x");return 0===t.length?null:1===t.length?{w:a(t[0]),h:1}:{w:a(t[0]),h:a(t[1])}}catch(i){}return null}},8437:function(e,t,i){var a,n,r,s,o,d,l,c,h=i(33994),u=i(22858),v=i(64599),p=i(35806),f=i(71008),_=i(62193),k=i(2816),y=i(27927),m=i(35890),g=(i(81027),i(15112)),b=i(29818),A=i(66066),w=i(94100),C=i(19244),E=i(42496),x=i(88800),I=(i(62745),i(82386),i(89655),i(39790),i(66457),i(253),i(54846),i(66555),i(10977)),S=i(34897),U=(i(13292),(0,y.A)([(0,b.EM)("ha-web-rtc-player")],(function(e,t){var i,s,o,d=function(t){function i(){var t;(0,f.A)(this,i);for(var a=arguments.length,n=new Array(a),r=0;r<a;r++)n[r]=arguments[r];return t=(0,_.A)(this,i,[].concat(n)),e(t),t}return(0,k.A)(i,t),(0,p.A)(i)}(t);return{F:d,d:[{kind:"field",decorators:[(0,b.MZ)({attribute:!1})],key:"hass",value:void 0},{kind:"field",decorators:[(0,b.MZ)()],key:"entityid",value:void 0},{kind:"field",decorators:[(0,b.MZ)({type:Boolean,attribute:"controls"})],key:"controls",value:function(){return!1}},{kind:"field",decorators:[(0,b.MZ)({type:Boolean,attribute:"muted"})],key:"muted",value:function(){return!1}},{kind:"field",decorators:[(0,b.MZ)({type:Boolean,attribute:"autoplay"})],key:"autoPlay",value:function(){return!1}},{kind:"field",decorators:[(0,b.MZ)({type:Boolean,attribute:"playsinline"})],key:"playsInline",value:function(){return!1}},{kind:"field",decorators:[(0,b.MZ)({attribute:"poster-url"})],key:"posterUrl",value:void 0},{kind:"field",decorators:[(0,b.wk)()],key:"_error",value:void 0},{kind:"field",decorators:[(0,b.P)("#remote-stream")],key:"_videoEl",value:void 0},{kind:"field",key:"_clientConfig",value:void 0},{kind:"field",key:"_peerConnection",value:void 0},{kind:"field",key:"_remoteStream",value:void 0},{kind:"field",key:"_unsub",value:void 0},{kind:"field",key:"_sessionId",value:void 0},{kind:"field",key:"_candidatesList",value:function(){return[]}},{kind:"method",key:"render",value:function(){return this._error?(0,g.qy)(a||(a=(0,v.A)(['<ha-alert alert-type="error">',"</ha-alert>"])),this._error):(0,g.qy)(n||(n=(0,v.A)([' <video id="remote-stream" ?autoplay="','" .muted="','" ?playsinline="','" ?controls="','" poster="','" @loadeddata="','"></video> '])),this.autoPlay,this.muted,this.playsInline,this.controls,(0,I.J)(this.posterUrl),this._loadedData)}},{kind:"method",key:"connectedCallback",value:function(){(0,m.A)(d,"connectedCallback",this,3)([]),this.hasUpdated&&this.entityid&&this._startWebRtc()}},{kind:"method",key:"disconnectedCallback",value:function(){(0,m.A)(d,"disconnectedCallback",this,3)([]),this._cleanUp()}},{kind:"method",key:"willUpdate",value:function(e){(0,m.A)(d,"willUpdate",this,3)([e]),e.has("entityid")&&this._startWebRtc()}},{kind:"method",key:"_startWebRtc",value:(o=(0,u.A)((0,h.A)().mark((function e(){var t=this;return(0,h.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._cleanUp(),"undefined"!=typeof RTCPeerConnection){e.next=5;break}return this._error="WebRTC is not supported in this browser",(0,S.r)(this,"streams",{hasAudio:!1,hasVideo:!1}),e.abrupt("return");case 5:if(this.hass&&this.entityid){e.next=7;break}return e.abrupt("return");case 7:return this._error=void 0,this._startTimer(),this._logEvent("start clientConfig"),e.next=12,(0,x.bT)(this.hass,this.entityid);case 12:this._clientConfig=e.sent,this._logEvent("end clientConfig",this._clientConfig),this._peerConnection=new RTCPeerConnection(this._clientConfig.configuration),this._clientConfig.dataChannel&&this._peerConnection.createDataChannel(this._clientConfig.dataChannel),this._peerConnection.onnegotiationneeded=this._startNegotiation,this._peerConnection.onicecandidate=this._handleIceCandidate,this._peerConnection.oniceconnectionstatechange=this._iceConnectionStateChanged,this._peerConnection.onsignalingstatechange=function(e){"stable"===e.target.signalingState?t._logEvent("ICE negotiation complete"):t._logEvent("Signaling state changed",e.target.signalingState)},this._remoteStream=new MediaStream,this._peerConnection.ontrack=this._addTrack,this._peerConnection.addTransceiver("audio",{direction:"recvonly"}),this._peerConnection.addTransceiver("video",{direction:"recvonly"});case 24:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{kind:"field",key:"_startNegotiation",value:function(){var e=this;return(0,u.A)((0,h.A)().mark((function t(){var i,a,n,r,s,o;return(0,h.A)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e._peerConnection){t.next=2;break}return t.abrupt("return");case 2:return a={offerToReceiveAudio:!0,offerToReceiveVideo:!0},e._logEvent("start createOffer",a),t.next=6,e._peerConnection.createOffer(a);case 6:if(n=t.sent,e._peerConnection){t.next=9;break}return t.abrupt("return");case 9:return e._logEvent("end createOffer",n),e._logEvent("start setLocalDescription"),t.next=13,e._peerConnection.setLocalDescription(n);case 13:if(e._peerConnection&&e.entityid){t.next=15;break}return t.abrupt("return");case 15:if(e._logEvent("end setLocalDescription"),r="",null===(i=e._clientConfig)||void 0===i||!i.getCandidatesUpfront){t.next=22;break}return t.next=20,new Promise((function(t){e._peerConnection.onicegatheringstatechange=function(i){var a=i.target.iceGatheringState;"complete"===a&&(e._peerConnection.onicegatheringstatechange=null,t()),e._logEvent("Ice gathering state changed",a)}}));case 20:if(e._peerConnection&&e.entityid){t.next=22;break}return t.abrupt("return");case 22:for(;e._candidatesList.length;)(s=e._candidatesList.pop())&&(r+="a=".concat(s,"\r\n"));o=n.sdp+r,e._logEvent("start webRtcOffer",o);try{e._unsub=(0,x.w8)(e.hass,e.entityid,o,(function(t){return e._handleOfferEvent(t)}))}catch(d){e._error="Failed to start WebRTC stream: "+d.message,e._cleanUp()}case 26:case"end":return t.stop()}}),t)})))}},{kind:"field",key:"_iceConnectionStateChanged",value:function(){var e=this;return function(){var t,i;e._logEvent("ice connection state change",null===(t=e._peerConnection)||void 0===t?void 0:t.iceConnectionState),"failed"===(null===(i=e._peerConnection)||void 0===i?void 0:i.iceConnectionState)&&e._peerConnection.restartIce()}}},{kind:"method",key:"_handleOfferEvent",value:(s=(0,u.A)((0,h.A)().mark((function e(t){var i,a=this;return(0,h.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.entityid){e.next=2;break}return e.abrupt("return");case 2:if("session"===t.type&&(this._sessionId=t.session_id,this._candidatesList.forEach((function(e){return(0,x.UC)(a.hass,a.entityid,t.session_id,e)})),this._candidatesList=[]),"answer"===t.type&&(this._logEvent("answer",t.answer),this._handleAnswer(t)),"candidate"!==t.type){e.next=14;break}return this._logEvent("remote ice candidate",t.candidate),e.prev=6,e.next=9,null===(i=this._peerConnection)||void 0===i?void 0:i.addIceCandidate(new RTCIceCandidate({candidate:t.candidate,sdpMid:"0"}));case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(6),console.error(e.t0);case 14:"error"===t.type&&(this._error="Failed to start WebRTC stream: "+t.message,this._cleanUp());case 15:case"end":return e.stop()}}),e,this,[[6,11]])}))),function(e){return s.apply(this,arguments)})},{kind:"field",key:"_handleIceCandidate",value:function(){var e=this;return function(t){var i,a,n,r;e.entityid&&null!==(i=t.candidate)&&void 0!==i&&i.candidate&&(e._logEvent("local ice candidate",null===(a=t.candidate)||void 0===a?void 0:a.candidate),e._sessionId?(0,x.UC)(e.hass,e.entityid,e._sessionId,null===(n=t.candidate)||void 0===n?void 0:n.candidate):e._candidatesList.push(null===(r=t.candidate)||void 0===r?void 0:r.candidate))}}},{kind:"field",key:"_addTrack",value:function(){var e=this;return function(){var t=(0,u.A)((0,h.A)().mark((function t(i){return(0,h.A)().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e._remoteStream){t.next=2;break}return t.abrupt("return");case 2:if(e._remoteStream.addTrack(i.track),e.hasUpdated){t.next=6;break}return t.next=6,e.updateComplete;case 6:e._videoEl.srcObject=e._remoteStream;case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}},{kind:"method",key:"_handleAnswer",value:(i=(0,u.A)((0,h.A)().mark((function e(t){var i,a;return(0,h.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==(i=this._peerConnection)&&void 0!==i&&i.signalingState&&!["stable","closed"].includes(this._peerConnection.signalingState)){e.next=2;break}return e.abrupt("return");case 2:return a=new RTCSessionDescription({type:"answer",sdp:t.answer}),e.prev=3,this._logEvent("start setRemoteDescription",a),e.next=7,this._peerConnection.setRemoteDescription(a);case 7:e.next=13;break;case 9:e.prev=9,e.t0=e.catch(3),this._error="Failed to connect WebRTC stream: "+e.t0.message,this._cleanUp();case 13:this._logEvent("end setRemoteDescription");case 14:case"end":return e.stop()}}),e,this,[[3,9]])}))),function(e){return i.apply(this,arguments)})},{kind:"method",key:"_cleanUp",value:function(){var e;this._remoteStream&&(this._remoteStream.getTracks().forEach((function(e){e.stop()})),this._remoteStream=void 0);var t=this._videoEl;t&&(t.removeAttribute("src"),t.load()),this._peerConnection&&(this._peerConnection.close(),this._peerConnection.onnegotiationneeded=null,this._peerConnection.onicecandidate=null,this._peerConnection.oniceconnectionstatechange=null,this._peerConnection.onicegatheringstatechange=null,this._peerConnection.ontrack=null,this._peerConnection.onsignalingstatechange=null,this._peerConnection=void 0,this._logEvent("stopped"),this._stopTimer()),null===(e=this._unsub)||void 0===e||e.then((function(e){return e()})),this._unsub=void 0,this._sessionId=void 0,this._candidatesList=[]}},{kind:"method",key:"_loadedData",value:function(){var e=this._videoEl.srcObject,t={hasAudio:Boolean(null==e?void 0:e.getAudioTracks().length),hasVideo:Boolean(null==e?void 0:e.getVideoTracks().length)};(0,S.r)(this,"load"),(0,S.r)(this,"streams",t),this._logEvent("loadedData",t),this._stopTimer()}},{kind:"method",key:"_startTimer",value:function(){}},{kind:"method",key:"_stopTimer",value:function(){}},{kind:"method",key:"_logEvent",value:function(e){}},{kind:"get",static:!0,key:"styles",value:function(){return(0,g.AH)(r||(r=(0,v.A)([":host,video{display:block}video{width:100%;max-height:var(--video-max-height,calc(100vh - 97px))}"])))}}]}}),g.WF),"mjpeg");(0,y.A)([(0,b.EM)("ha-camera-stream")],(function(e,t){var i,a,n=function(t){function i(){var t;(0,f.A)(this,i);for(var a=arguments.length,n=new Array(a),r=0;r<a;r++)n[r]=arguments[r];return t=(0,_.A)(this,i,[].concat(n)),e(t),t}return(0,k.A)(i,t),(0,p.A)(i)}(t);return{F:n,d:[{kind:"field",decorators:[(0,b.MZ)({attribute:!1})],key:"hass",value:void 0},{kind:"field",decorators:[(0,b.MZ)({attribute:!1})],key:"stateObj",value:void 0},{kind:"field",decorators:[(0,b.MZ)({type:Boolean,attribute:"controls"})],key:"controls",value:function(){return!1}},{kind:"field",decorators:[(0,b.MZ)({type:Boolean,attribute:"muted"})],key:"muted",value:function(){return!1}},{kind:"field",decorators:[(0,b.MZ)({type:Boolean,attribute:"allow-exoplayer"})],key:"allowExoPlayer",value:function(){return!1}},{kind:"field",decorators:[(0,b.wk)()],key:"_posterUrl",value:void 0},{kind:"field",decorators:[(0,b.wk)()],key:"_connected",value:function(){return!1}},{kind:"field",decorators:[(0,b.wk)()],key:"_capabilities",value:void 0},{kind:"field",decorators:[(0,b.wk)()],key:"_hlsStreams",value:void 0},{kind:"field",decorators:[(0,b.wk)()],key:"_webRtcStreams",value:void 0},{kind:"method",key:"willUpdate",value:function(e){var t;e.has("stateObj")&&this.stateObj&&(null===(t=e.get("stateObj"))||void 0===t?void 0:t.entity_id)!==this.stateObj.entity_id&&(this._getCapabilities(),this._getPosterUrl())}},{kind:"method",key:"connectedCallback",value:function(){(0,m.A)(n,"connectedCallback",this,3)([]),this._connected=!0}},{kind:"method",key:"disconnectedCallback",value:function(){(0,m.A)(n,"disconnectedCallback",this,3)([]),this._connected=!1}},{kind:"method",key:"render",value:function(){var e,t=this;if(!this.stateObj)return g.s6;var i=this._streams(null===(e=this._capabilities)||void 0===e?void 0:e.frontend_stream_types,this._hlsStreams,this._webRtcStreams);return(0,g.qy)(s||(s=(0,v.A)(["",""])),(0,A.u)(i,(function(e){return e.type+t.stateObj.entity_id}),(function(e){return t._renderStream(e)})))}},{kind:"method",key:"_renderStream",value:function(e){return this.stateObj?e.type===U?(0,g.qy)(o||(o=(0,v.A)(['<img .src="','" alt="','">'])),this._connected?(0,x.CK)(this.stateObj):this._posterUrl||"","Preview of the ".concat((0,C.u)(this.stateObj)," camera.")):e.type===x.Ub?(0,g.qy)(d||(d=(0,v.A)(['<ha-hls-player autoplay playsinline .allowExoPlayer="','" .muted="','" .controls="','" .hass="','" .entityid="','" .posterUrl="','" @streams="','" class="','"></ha-hls-player>'])),this.allowExoPlayer,this.muted,this.controls,this.hass,this.stateObj.entity_id,this._posterUrl,this._handleHlsStreams,e.visible?"":"hidden"):e.type===x.zS?(0,g.qy)(l||(l=(0,v.A)(['<ha-web-rtc-player autoplay playsinline .muted="','" .controls="','" .hass="','" .entityid="','" .posterUrl="','" @streams="','" class="','"></ha-web-rtc-player>'])),this.muted,this.controls,this.hass,this.stateObj.entity_id,this._posterUrl,this._handleWebRtcStreams,e.visible?"":"hidden"):g.s6:g.s6}},{kind:"method",key:"_getCapabilities",value:(a=(0,u.A)((0,h.A)().mark((function e(){return(0,h.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._capabilities=void 0,this._hlsStreams=void 0,this._webRtcStreams=void 0,(0,E.$)(this.stateObj,x.JT)){e.next=6;break}return this._capabilities={frontend_stream_types:[]},e.abrupt("return");case 6:return e.next=8,(0,x._Z)(this.hass,this.stateObj.entity_id);case 8:this._capabilities=e.sent;case 9:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{kind:"method",key:"_getPosterUrl",value:(i=(0,u.A)((0,h.A)().mark((function e(){return(0,h.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,x.C4)(this.hass,this.stateObj.entity_id,this.clientWidth,this.clientHeight);case 3:this._posterUrl=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),this._posterUrl=void 0;case 9:case"end":return e.stop()}}),e,this,[[0,6]])}))),function(){return i.apply(this,arguments)})},{kind:"method",key:"_handleHlsStreams",value:function(e){this._hlsStreams=e.detail}},{kind:"method",key:"_handleWebRtcStreams",value:function(e){this._webRtcStreams=e.detail}},{kind:"field",key:"_streams",value:function(){return(0,w.A)((function(e,t,i){if(!e)return[];if(0===e.length)return[{type:U,visible:!0}];if(1===e.length)return e[0]===x.Ub&&!1===(null==t?void 0:t.hasVideo)||e[0]===x.zS&&!1===(null==i?void 0:i.hasVideo)?[{type:U,visible:!0}]:[{type:e[0],visible:!0}];if(t&&i)return t.hasVideo&&t.hasAudio&&!i.hasAudio?[{type:x.Ub,visible:!0}]:i.hasVideo?[{type:x.zS,visible:!0}]:[{type:U,visible:!0}];if((null==t?void 0:t.hasVideo)!==(null==i?void 0:i.hasVideo)){if(null!=t&&t.hasVideo)return[{type:x.Ub,visible:!0},{type:x.zS,visible:!1}];if(!1===(null==t?void 0:t.hasVideo))return[{type:x.zS,visible:!0}];if(null!=i&&i.hasVideo)return[{type:x.zS,visible:!0},{type:x.Ub,visible:!1}];if(!1===(null==i?void 0:i.hasVideo))return[{type:x.Ub,visible:!0}]}return[{type:x.Ub,visible:!0},{type:x.zS,visible:!1}]}))}},{kind:"get",static:!0,key:"styles",value:function(){return(0,g.AH)(c||(c=(0,v.A)([":host,img{display:block}img{width:100%}.hidden{display:none}"])))}}]}}),g.WF)},62745:function(e,t,i){var a,n,r,s,o=i(33994),d=i(22858),l=i(64599),c=i(35806),h=i(71008),u=i(62193),v=i(2816),p=i(27927),f=i(35890),_=(i(88871),i(81027),i(82386),i(95737),i(39790),i(66457),i(36016),i(7760),i(36604),i(99019),i(96858),i(84341),i(49365),i(38389),i(74860),i(71011),i(71174),i(15112)),k=i(29818),y=i(34897),m=i(61441),g=(i(13292),i(88800)),b=i(33922);(0,p.A)([(0,k.EM)("ha-hls-player")],(function(e,t){var p,A,w,C,E,x=function(t){function i(){var t;(0,h.A)(this,i);for(var a=arguments.length,n=new Array(a),r=0;r<a;r++)n[r]=arguments[r];return t=(0,u.A)(this,i,[].concat(n)),e(t),t}return(0,v.A)(i,t),(0,c.A)(i)}(t);return{F:x,d:[{kind:"field",decorators:[(0,k.MZ)({attribute:!1})],key:"hass",value:void 0},{kind:"field",decorators:[(0,k.MZ)()],key:"entityid",value:void 0},{kind:"field",decorators:[(0,k.MZ)({attribute:"poster-url"})],key:"posterUrl",value:void 0},{kind:"field",decorators:[(0,k.MZ)({type:Boolean,attribute:"controls"})],key:"controls",value:function(){return!1}},{kind:"field",decorators:[(0,k.MZ)({type:Boolean,attribute:"muted"})],key:"muted",value:function(){return!1}},{kind:"field",decorators:[(0,k.MZ)({type:Boolean,attribute:"autoplay"})],key:"autoPlay",value:function(){return!1}},{kind:"field",decorators:[(0,k.MZ)({type:Boolean,attribute:"playsinline"})],key:"playsInline",value:function(){return!1}},{kind:"field",decorators:[(0,k.MZ)({type:Boolean,attribute:"allow-exoplayer"})],key:"allowExoPlayer",value:function(){return!1}},{kind:"field",decorators:[(0,k.P)("video")],key:"_videoEl",value:void 0},{kind:"field",decorators:[(0,k.wk)()],key:"_error",value:void 0},{kind:"field",decorators:[(0,k.wk)()],key:"_errorIsFatal",value:function(){return!1}},{kind:"field",decorators:[(0,k.wk)()],key:"_url",value:void 0},{kind:"field",key:"_hlsPolyfillInstance",value:void 0},{kind:"field",key:"_exoPlayer",value:function(){return!1}},{kind:"field",static:!0,key:"streamCount",value:function(){return 0}},{kind:"method",key:"connectedCallback",value:function(){(0,f.A)(x,"connectedCallback",this,3)([]),x.streamCount+=1,this.hasUpdated&&(this._resetError(),this._startHls())}},{kind:"method",key:"disconnectedCallback",value:function(){(0,f.A)(x,"disconnectedCallback",this,3)([]),x.streamCount-=1,this._cleanUp()}},{kind:"method",key:"render",value:function(){return(0,_.qy)(a||(a=(0,l.A)([" "," "," "])),this._error?(0,_.qy)(n||(n=(0,l.A)(['<ha-alert alert-type="error" class="','"> '," </ha-alert>"])),this._errorIsFatal?"fatal":"retry",this._error):"",this._errorIsFatal?"":(0,_.qy)(r||(r=(0,l.A)(['<video .poster="','" ?autoplay="','" .muted="','" ?playsinline="','" ?controls="','" @loadeddata="','"></video>'])),this.posterUrl,this.autoPlay,this.muted,this.playsInline,this.controls,this._loadedData))}},{kind:"method",key:"updated",value:function(e){(0,f.A)(x,"updated",this,3)([e]),e.has("entityid")&&this._getStreamUrl()}},{kind:"method",key:"_getStreamUrl",value:(E=(0,d.A)((0,o.A)().mark((function e(){var t,i;return(0,o.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._cleanUp(),this._resetError(),(0,b.x)(this.hass,"stream")){e.next=5;break}return this._setFatalError("Streaming component is not loaded."),e.abrupt("return");case 5:if(this.entityid){e.next=7;break}return e.abrupt("return");case 7:return e.prev=7,e.next=10,(0,g.wv)(this.hass,this.entityid);case 10:t=e.sent,i=t.url,this._url=i,this._cleanUp(),this._resetError(),this._startHls(),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(7),console.error(e.t0),(0,y.r)(this,"streams",{hasAudio:!1,hasVideo:!1});case 22:case"end":return e.stop()}}),e,this,[[7,18]])}))),function(){return E.apply(this,arguments)})},{kind:"method",key:"_startHls",value:(C=(0,d.A)((0,o.A)().mark((function e(){var t,a,n,r,s,d,l,c,h,u,v;return(0,o.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=fetch(this._url),e.next=3,Promise.all([i.e(72915),i.e(96860)]).then(i.bind(i,96860));case 3:if(n=e.sent.default,this.isConnected){e.next=6;break}return e.abrupt("return");case 6:if((r=n.isSupported())||(r=""!==this._videoEl.canPlayType("application/vnd.apple.mpegurl")),r){e.next=11;break}return this._setFatalError(this.hass.localize("ui.components.media-browser.video_not_supported")),e.abrupt("return");case 11:return s=this.allowExoPlayer&&(null===(t=this.hass.auth.external)||void 0===t?void 0:t.config.hasExoPlayer),e.next=14,a;case 14:return e.next=16,e.sent.text();case 16:if(d=e.sent,this.isConnected){e.next=19;break}return e.abrupt("return");case 19:c=(l=/#EXT-X-STREAM-INF:.*?(?:CODECS=".*?([^.]*)?\..*?,([^.]*)?\..*?".*?)?(?:\n|\r\n)(.+)/g).exec(d),h=l.exec(d),u=null!==c&&null===h?new URL(c[3],this._url).href:this._url,v=c?"".concat(c[1],",").concat(c[2]):void 0,this._reportStreams(v),s&&(null!=v&&v.includes("hevc")||null!=v&&v.includes("hev1"))?this._renderHLSExoPlayer(u):n.isSupported()?this._renderHLSPolyfill(this._videoEl,n,u):this._renderHLSNative(this._videoEl,u);case 26:case"end":return e.stop()}}),e,this)}))),function(){return C.apply(this,arguments)})},{kind:"method",key:"_renderHLSExoPlayer",value:(w=(0,d.A)((0,o.A)().mark((function e(t){return(0,o.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._exoPlayer=!0,window.addEventListener("resize",this._resizeExoPlayer),this.updateComplete.then((function(){return(0,m.E)()})).then(this._resizeExoPlayer),this._videoEl.style.visibility="hidden",e.next=6,this.hass.auth.external.fireMessage({type:"exoplayer/play_hls",payload:{url:new URL(t,window.location.href).toString(),muted:this.muted}});case 6:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{kind:"field",key:"_resizeExoPlayer",value:function(){var e=this;return function(){if(e._videoEl){var t=e._videoEl.getBoundingClientRect();e.hass.auth.external.fireMessage({type:"exoplayer/resize",payload:{left:t.left,top:t.top,right:t.right,bottom:t.bottom}})}}}},{kind:"method",key:"_isLLHLSSupported",value:function(){if(x.streamCount<=2)return!0;if(!("performance"in window)||0===performance.getEntriesByType("resource").length)return!1;var e=performance.getEntriesByType("resource")[0];return"nextHopProtocol"in e&&"h2"===e.nextHopProtocol}},{kind:"method",key:"_renderHLSPolyfill",value:(A=(0,d.A)((0,o.A)().mark((function e(t,i,a){var n,r=this;return(0,o.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=new i({backBufferLength:60,fragLoadingTimeOut:3e4,manifestLoadingTimeOut:3e4,levelLoadingTimeOut:3e4,maxLiveSyncPlaybackRate:2,lowLatencyMode:this._isLLHLSSupported()}),this._hlsPolyfillInstance=n,n.attachMedia(t),n.on(i.Events.MEDIA_ATTACHED,(function(){r._resetError(),n.loadSource(a)})),n.on(i.Events.FRAG_LOADED,(function(e,t){r._resetError()})),n.on(i.Events.ERROR,(function(e,t){if(t.fatal)if(t.type===i.ErrorTypes.NETWORK_ERROR){switch(t.details){case i.ErrorDetails.MANIFEST_LOAD_ERROR:var a="Error starting stream, see logs for details";void 0!==t.response&&void 0!==t.response.code&&(t.response.code>=500?a+=" (Server failure)":t.response.code>=400?a+=" (Stream never started)":a+=" ("+t.response.code+")"),r._setRetryableError(a);break;case i.ErrorDetails.MANIFEST_LOAD_TIMEOUT:r._setRetryableError("Timeout while starting stream");break;default:r._setRetryableError("Stream network error")}n.startLoad()}else t.type===i.ErrorTypes.MEDIA_ERROR?(r._setRetryableError("Error with media stream contents"),n.recoverMediaError()):r._setFatalError("Error playing stream")}));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,i){return A.apply(this,arguments)})},{kind:"method",key:"_renderHLSNative",value:(p=(0,d.A)((0,o.A)().mark((function e(t,i){return(0,o.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.src=i,t.addEventListener("loadedmetadata",(function(){t.play()}));case 2:case"end":return e.stop()}}),e)}))),function(e,t){return p.apply(this,arguments)})},{kind:"method",key:"_cleanUp",value:function(){this._hlsPolyfillInstance&&(this._hlsPolyfillInstance.destroy(),this._hlsPolyfillInstance=void 0),this._exoPlayer&&(window.removeEventListener("resize",this._resizeExoPlayer),this.hass.auth.external.fireMessage({type:"exoplayer/stop"}),this._exoPlayer=!1),this._videoEl&&(this._videoEl.removeAttribute("src"),this._videoEl.load())}},{kind:"method",key:"_resetError",value:function(){this._error=void 0,this._errorIsFatal=!1}},{kind:"method",key:"_setFatalError",value:function(e){this._error=e,this._errorIsFatal=!0,(0,y.r)(this,"streams",{hasAudio:!1,hasVideo:!1})}},{kind:"method",key:"_setRetryableError",value:function(e){this._error=e,this._errorIsFatal=!1,(0,y.r)(this,"streams",{hasAudio:!1,hasVideo:!1})}},{kind:"method",key:"_reportStreams",value:function(e){var t,i=null==e?void 0:e.split(",");(0,y.r)(this,"streams",{hasAudio:null!==(t=null==i?void 0:i.includes("mp4a"))&&void 0!==t&&t,hasVideo:null!=i&&i.includes("mp4a")?(null==i?void 0:i.length)>1:Boolean(null==i?void 0:i.length)})}},{kind:"method",key:"_loadedData",value:function(){(0,y.r)(this,"load")}},{kind:"get",static:!0,key:"styles",value:function(){return(0,_.AH)(s||(s=(0,l.A)([":host,video{display:block}video{width:100%;max-height:var(--video-max-height,calc(100vh - 97px))}.fatal{display:block;padding:100px 16px}.retry{display:block}"])))}}]}}),_.WF)},9755:function(e,t,i){i.d(t,{e:function(){return a}});i(81027);var a=function(e){return"/api/image_proxy/".concat(e.entity_id,"?token=").concat(e.attributes.access_token,"&state=").concat(e.state)}},16204:function(e,t,i){var a,n,r,s,o,d,l=i(33994),c=i(22858),h=i(64599),u=i(35806),v=i(71008),p=i(62193),f=i(2816),_=i(27927),k=i(35890),y=(i(81027),i(13025),i(82386),i(82115),i(39790),i(36604),i(253),i(2075),i(15112)),m=i(29818),g=i(85323),b=i(63073),A=i(94872),w=i(213),C=i(77226),E=(i(8437),i(37629),i(88800)),x=i(9883),I=i(9755),S=function(e){return e[e.Loading=1]="Loading",e[e.Loaded=2]="Loaded",e[e.Error=3]="Error",e}(S||{});(0,_.A)([(0,m.EM)("hui-image")],(function(e,t){var i,_,U,M,L=function(t){function i(){var t;(0,v.A)(this,i);for(var a=arguments.length,n=new Array(a),r=0;r<a;r++)n[r]=arguments[r];return t=(0,p.A)(this,i,[].concat(n)),e(t),t}return(0,f.A)(i,t),(0,u.A)(i)}(t);return{F:L,d:[{kind:"field",decorators:[(0,m.MZ)({attribute:!1})],key:"hass",value:void 0},{kind:"field",decorators:[(0,m.MZ)()],key:"entity",value:void 0},{kind:"field",decorators:[(0,m.MZ)()],key:"image",value:void 0},{kind:"field",decorators:[(0,m.MZ)({attribute:!1})],key:"stateImage",value:void 0},{kind:"field",decorators:[(0,m.MZ)()],key:"cameraImage",value:void 0},{kind:"field",decorators:[(0,m.MZ)()],key:"cameraView",value:void 0},{kind:"field",decorators:[(0,m.MZ)()],key:"aspectRatio",value:void 0},{kind:"field",decorators:[(0,m.MZ)()],key:"filter",value:void 0},{kind:"field",decorators:[(0,m.MZ)({attribute:!1})],key:"stateFilter",value:void 0},{kind:"field",decorators:[(0,m.MZ)()],key:"darkModeImage",value:void 0},{kind:"field",decorators:[(0,m.MZ)()],key:"darkModeFilter",value:void 0},{kind:"field",decorators:[(0,m.MZ)()],key:"fitMode",value:void 0},{kind:"field",decorators:[(0,m.wk)()],key:"_imageVisible",value:function(){return!1}},{kind:"field",decorators:[(0,m.wk)()],key:"_loadState",value:void 0},{kind:"field",decorators:[(0,m.wk)()],key:"_cameraImageSrc",value:void 0},{kind:"field",decorators:[(0,m.wk)()],key:"_loadedImageSrc",value:void 0},{kind:"field",decorators:[(0,m.wk)()],key:"_lastImageHeight",value:void 0},{kind:"field",key:"_intersectionObserver",value:void 0},{kind:"field",key:"_cameraUpdater",value:void 0},{kind:"field",key:"_ratio",value:function(){return null}},{kind:"method",key:"connectedCallback",value:function(){(0,k.A)(L,"connectedCallback",this,3)([]),void 0===this._loadState&&(this._loadState=S.Loading),this.cameraImage&&"live"!==this.cameraView&&this._startIntersectionObserverOrUpdates()}},{kind:"method",key:"disconnectedCallback",value:function(){(0,k.A)(L,"disconnectedCallback",this,3)([]),this._stopUpdateCameraInterval(),this._stopIntersectionObserver(),this._imageVisible=void 0}},{kind:"method",key:"handleIntersectionCallback",value:function(e){this._imageVisible=e[0].isIntersecting}},{kind:"method",key:"willUpdate",value:function(e){if(e.has("hass")){var t=e.get("hass");this._shouldStartCameraUpdates(t)?this._startIntersectionObserverOrUpdates():this.hass.connected||(this._stopUpdateCameraInterval(),this._stopIntersectionObserver(),this._loadState=S.Loading,this._cameraImageSrc=void 0,this._loadedImageSrc=void 0)}e.has("_imageVisible")&&(this._imageVisible?this._shouldStartCameraUpdates()&&this._startUpdateCameraInterval():this._stopUpdateCameraInterval()),e.has("aspectRatio")&&(this._ratio=this.aspectRatio?(0,C.A)(this.aspectRatio):null),this._loadState!==S.Loading||this.cameraImage||(this._loadState=S.Loaded)}},{kind:"method",key:"render",value:function(){if(!this.hass)return y.s6;var e,t,i=Boolean(this._ratio&&this._ratio.w>0&&this._ratio.h>0),d=this.entity?this.hass.states[this.entity]:void 0,l=d?d.state:x.Hh,c=!this.stateImage;if(this.cameraImage)"live"===this.cameraView?t=this.hass.states[this.cameraImage]:e=this._cameraImageSrc;else if(this.stateImage){var u=this.stateImage[l];u?e=u:(e=this.image,c=!0)}else e=this.darkModeImage&&this.hass.themes.darkMode?this.darkModeImage:d&&"image"===(0,w.m)(d.entity_id)?(0,I.e)(d):this.image;e&&(e=this.hass.hassUrl(e));var v=this.filter||"";(this.hass.themes.darkMode&&this.darkModeFilter&&(v+=this.darkModeFilter),this.stateFilter&&this.stateFilter[l]&&(v+=this.stateFilter[l]),!v&&this.entity)&&(v=(!d||A.jj.includes(l))&&c?"grayscale(100%)":"");return(0,y.qy)(a||(a=(0,h.A)([' <div style="','" class="container ','"> '," "," </div> "])),(0,b.W)({paddingBottom:i?"".concat((100*this._ratio.h/this._ratio.w).toFixed(2),"%"):void 0===this._lastImageHeight?"56.25%":void 0,backgroundImage:i&&this._loadedImageSrc?'url("'.concat(this._loadedImageSrc,'")'):void 0,filter:this._loadState===S.Loaded||"live"===this.cameraView?v:void 0}),(0,g.H)({ratio:i||void 0===this._lastImageHeight,contain:"contain"===this.fitMode,fill:"fill"===this.fitMode}),this.cameraImage&&"live"===this.cameraView?(0,y.qy)(n||(n=(0,h.A)([' <ha-camera-stream muted .hass="','" .stateObj="','" @load="','"></ha-camera-stream> '])),this.hass,t,this._onVideoLoad):void 0===e?y.s6:(0,y.qy)(r||(r=(0,h.A)([' <img id="image" src="','" @error="','" @load="','" style="','"> '])),e,this._onImageError,this._onImageLoad,(0,b.W)({display:i||this._loadState===S.Loaded?"block":"none"})),this._loadState===S.Error?(0,y.qy)(s||(s=(0,h.A)(['<div id="brokenImage" style="','"></div>'])),(0,b.W)({height:i?void 0:"".concat(this._lastImageHeight,"px")||0})):"live"===this.cameraView||void 0!==e&&this._loadState!==S.Loading?"":(0,y.qy)(o||(o=(0,h.A)(['<div class="progress-container" style="','"> <ha-circular-progress class="render-spinner" indeterminate size="small"></ha-circular-progress> </div>'])),(0,b.W)({height:i?void 0:"".concat(this._lastImageHeight,"px")||0})))}},{kind:"method",key:"_shouldStartCameraUpdates",value:function(e){return!(e&&e.connected===this.hass.connected||!this.hass.connected||"live"===this.cameraView)}},{kind:"method",key:"_startIntersectionObserverOrUpdates",value:function(){"IntersectionObserver"in window?(this._intersectionObserver||(this._intersectionObserver=new IntersectionObserver(this.handleIntersectionCallback.bind(this))),this._intersectionObserver.observe(this)):(this._imageVisible=!0,this._startUpdateCameraInterval())}},{kind:"method",key:"_stopIntersectionObserver",value:function(){this._intersectionObserver&&this._intersectionObserver.disconnect()}},{kind:"method",key:"_startUpdateCameraInterval",value:function(){var e=this;this._stopUpdateCameraInterval(),this._updateCameraImageSrc(),this.cameraImage&&this.isConnected&&(this._cameraUpdater=window.setInterval((function(){return e._updateCameraImageSrcAtInterval()}),1e4))}},{kind:"method",key:"_stopUpdateCameraInterval",value:function(){this._cameraUpdater&&(clearInterval(this._cameraUpdater),this._cameraUpdater=void 0)}},{kind:"method",key:"_onImageError",value:function(){this._loadState=S.Error}},{kind:"method",key:"_onImageLoad",value:(M=(0,c.A)((0,l.A)().mark((function e(t){var i;return(0,l.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._loadState=S.Loaded,i=t.target,this._ratio&&this._ratio.w>0&&this._ratio.h>0&&(this._loadedImageSrc=i.src),e.next=5,this.updateComplete;case 5:this._lastImageHeight=i.offsetHeight;case 6:case"end":return e.stop()}}),e,this)}))),function(e){return M.apply(this,arguments)})},{kind:"method",key:"_onVideoLoad",value:(U=(0,c.A)((0,l.A)().mark((function e(t){var i;return(0,l.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._loadState=S.Loaded,i=t.currentTarget,e.next=4,this.updateComplete;case 4:this._lastImageHeight=i.offsetHeight;case 5:case"end":return e.stop()}}),e,this)}))),function(e){return U.apply(this,arguments)})},{kind:"method",key:"_updateCameraImageSrcAtInterval",value:(_=(0,c.A)((0,l.A)().mark((function e(){return(0,l.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._loadState===S.Loading&&this._onImageError(),e.abrupt("return",this._updateCameraImageSrc());case 2:case"end":return e.stop()}}),e,this)}))),function(){return _.apply(this,arguments)})},{kind:"method",key:"_updateCameraImageSrc",value:(i=(0,c.A)((0,l.A)().mark((function e(){var t,i,a;return(0,l.A)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hass&&this.cameraImage){e.next=2;break}return e.abrupt("return");case 2:if(this.hass.states[this.cameraImage]){e.next=6;break}return this._onImageError(),e.abrupt("return");case 6:return t=this.clientWidth||640,i=Math.ceil(t*devicePixelRatio),this._lastImageHeight?a=Math.ceil(this._lastImageHeight*devicePixelRatio):this._ratio&&this._ratio.w>0&&this._ratio.h>0?a=Math.ceil(i*(this._ratio.h/this._ratio.w)):(i*=2,a=Math.ceil(.5625*i)),e.next=11,(0,E.C4)(this.hass,this.cameraImage,i,a);case 11:this._cameraImageSrc=e.sent,void 0===this._cameraImageSrc&&this._onImageError();case 13:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{kind:"get",static:!0,key:"styles",value:function(){return(0,y.AH)(d||(d=(0,h.A)([':host{display:block}.container{transition:filter .2s linear;height:100%}img{display:block;height:100%;width:100%;object-fit:cover}.progress-container{display:flex;justify-content:center;align-items:center}.ratio{position:relative;width:100%;height:0;background-position:center;background-size:cover}.ratio.fill{background-size:100% 100%}.ratio.contain{background-size:contain;background-repeat:no-repeat}.fill img{object-fit:fill}.contain img{object-fit:contain}.ratio div,.ratio img{position:absolute;top:0;left:0;width:100%;height:100%}.ratio img{visibility:hidden}#brokenImage{background:grey url("/static/images/image-broken.svg") center/36px no-repeat}'])))}}]}}),y.WF)}}]);
//# sourceMappingURL=16204.ySIoVuO6TUE.js.map